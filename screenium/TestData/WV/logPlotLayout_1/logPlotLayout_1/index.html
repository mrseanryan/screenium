<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>log plot layout tryout</title>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

    <link href="http://cdn.kendostatic.com/2015.2.624/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2015.2.624/styles/kendo.default.min.css" rel="stylesheet" />

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <script src="http://cdn.kendostatic.com/2015.2.624/js/kendo.all.min.js"></script>
    <!--<script src="http://cdn.kendostatic.com/2015.2.624/js/kendo.timezones.min.js"></script>-->
</head>
<body>
    <!-- WV uses tables for zones:-->
    <table>
        <tr>
            <td id="tdZone1" width="600px">
                <div id="zone1">
                    <!-- LP here in zone 1 -->
                    <!--LP control: width and height-->
                    <div id="example" style="border: solid 1px black; height: 700px; width:500px;">

                        <div id="vertical" style="height: 97%; width: 99%;">
                            <div id="top-pane">
                                <div id="horizontal-headings" style="height: 100%; width: 100%;">
                                    <div id="column0-pane-heading">
                                        <img src="images/wv_lp_ruler_heading.png" class="stretch-image" />
                                    </div>
                                    <div id="column1-pane-heading">
                                        <img src="images/wv_lp_column1_header.png" class="stretch-image" />
                                    </div>
                                    <div id="column2-pane-heading">
                                        <img src="images/wv_lp_column2_header.png" class="stretch-image" />
                                    </div>
                                    <div id="column3-pane-heading">
                                        <img src="images/wv_lp_column3_header.png" class="stretch-image" />
                                    </div>
                                </div>
                            </div>
                            <div id="middle-pane">
                                <div id="horizontal-main" style="height: 100%; width: 100%;">
                                    <div id="column0-pane-main">
                                        <img src="images/wv_lp_ruler_main.png" class="stretch-image" />
                                    </div>
                                    <div id="column1-pane-main">
                                        <img src="images/wv_lp_column1_main.png" class="stretch-image" />
                                    </div>
                                    <div id="column2-pane-main">
                                        <img src="images/wv_lp_column2_main.png" class="stretch-image" />
                                    </div>
                                    <div id="column3-pane-main">
                                        <img src="images/wv_lp_column3_main.png" class="stretch-image" />
                                    </div>
                                </div>
                            </div>
                            <div id="bottom-pane">
                                <div id="horizontal-footers" style="height: 100%; width: 100%;">
                                    <div id="column0-pane-footer">
                                        <!--empty-->
                                    </div>
                                    <div id="column1-pane-footer">
                                        <img src="images/wv_lp_column1_footer.png" class="stretch-image" />
                                    </div>
                                    <div id="column2-pane-footer">
                                        <img src="images/wv_lp_column2_footer.png" class="stretch-image" />
                                    </div>
                                    <div id="column3-pane-footer">
                                        <img src="images/wv_lp_column3_footer.png" class="stretch-image" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="verticalSpaceAtBottom" style="height:15px;">&nbsp;</div>
                    </div>

                <!-- ReSharper disable once UnusedParameter -->
                    <script>
                        var mainVerticalSplitter;
                        var headingsHorizontalSplitter;
                        var headings2HorizontalSplitter;
                        var mainHorizontalSplitter;
                        var footersHorizontalSplitter;

                        var createKendoSplitters = function () {

                            $("#vertical").kendoSplitter({
                                orientation: "vertical",
                                panes: [
                                    { collapsible: true, resizable: true, size: "50px" }, //headings
                                    { collapsible: false, resizable: true }, //main
                                    { collapsible: true, resizable: true, size: "50px" } //footer
                                ]
                            });
                            mainVerticalSplitter = $("#vertical").data("kendoSplitter");

                            $("#horizontal-headings").kendoSplitter({
                                panes: [
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false }
                                ]
                            });
                            headingsHorizontalSplitter = $("#horizontal-headings").data("kendoSplitter");

                            $("#horizontal-main").kendoSplitter({
                                panes: [
                                    { collapsible: true, scrollable: false },
                                    { collapsible: true, scrollable: false },
                                    { collapsible: true, scrollable: false },
                                    { collapsible: true, scrollable: false }
                                ],
                                expand: onExpandMainHorizontal,
                                collapse: onCollapseMainHorizontal,
                                contentload: onContentLoadMainHorizontal,
                                resize: onResizeMainHorizontal
                            });
                            mainHorizontalSplitter = $("#horizontal-main").data('kendoSplitter');

                            $("#horizontal-footers").kendoSplitter({
                                panes: [
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false },
                                    { collapsible: false, resizable: false, scrollable: false }
                                ]
                            });
                            footersHorizontalSplitter = $("#horizontal-footers").data('kendoSplitter');
                        };

                        $(document).ready(function () {

                            createKendoSplitters();

                            //jQuery resizable:
                            $('#example').resizable({
                                //handles: "e"
                            });

                            makeColumnsDraggable();
                        });

                        var makeColumnsDraggable = function () {
                            for (var dragColumn in columnPrefixes) {
                                if (columnPrefixes.hasOwnProperty(dragColumn)) {
                                    dragColumn = columnPrefixes[dragColumn];

                                    for(var dropColumn in columnPrefixes) {
                                        if(columnPrefixes.hasOwnProperty(dropColumn)) {
                                            dropColumn = columnPrefixes[dropColumn];
                                            if(dragColumn !== dropColumn) {
                                                makeColumnDraggable(dragColumn, dropColumn);
                                            }
                                        }
                                    }
                                }
                            }
                        };

                        var makeColumnDraggable = function (columnPrefix) {
                            var getDraggableIdFromEvent = function (e) {
                                var draggableId;
                                if(e.draggable) {
                                    draggableId = e.draggable.element[0].id;
                                } else {
                                    return null;
                                }
                                if(typeof (draggableId) === 'undefined') {
                                    throw 'cannot find id!';
                                }
                                return draggableId;
                            };

                            var getDropTargetIdFromEvent = function (e) {
                                var dropTargetId;
                                if(e.dropTarget) {
                                    dropTargetId = e.dropTarget[0].id;
                                } else {
                                    return null;
                                }
                                if (typeof (dropTargetId) === 'undefined') {
                                    throw 'cannot find id!';
                                }
                                return dropTargetId;
                            };

                            var setCursorAsDefault = function() {
                                $('body').css('cursor', 'default');
                            };
                            var setCursorAsDenied = function() {
                                $('body').css('cursor', 'not-allowed');
                            };
                            var setCursorAsDragging = function () {
                                $('body').css('cursor', 'move');
                            };
                            var setCursorAsDroppable = function () {
                                $('body').css('cursor', 'move');
                            };

                            var droptargetOnDragEnter = function (e) {
                                var draggableId = getDraggableIdFromEvent(e);
                                var dropTargetId = getDropTargetIdFromEvent(e);

                                if(draggableId !== dropTargetId) {
                                    $("#" + dropTargetId).addClass("dropTargetEntered");

                                    setCursorAsDroppable();
                                }
                            };
                            var droptargetOnDragLeave = function(e) {
                                var dropTargetId = getDropTargetIdFromEvent(e);

                                $("#" + dropTargetId).removeClass("dropTargetEntered");

                                setCursorAsDragging();
                            };
                            var getColumnPrefixFromDragDrop = function (id) {
                                id = id.split('-')[0];
                                return id;
                            };
                            var restoreMouseAndUi = function (draggableId, dropTargetId) {
                                var draggable = $("#" + draggableId);
                                draggable.removeClass("draggableOnDrag");
                                if (dropTargetId) {
                                    $("#" + dropTargetId).removeClass("dropTargetEntered");
                                }
                                setCursorAsDefault();
                            };

                            var droptargetOnDrop = function (e) {
                                var draggableId = getDraggableIdFromEvent(e);
                                var dropTargetId = getDropTargetIdFromEvent(e);

                                var draggable = $("#" + draggableId);

                                restoreMouseAndUi(draggableId, dropTargetId);

                                if (!draggableId || !dropTargetId) {
                                    return;
                                }

                                if (!draggable.data("kendoDraggable")) {
                                    // drag ended outside of any droptarget
                                    return;
                                }

                                var dropColumnPrefix = getColumnPrefixFromDragDrop(dropTargetId);
                                var dragColumnPrefix = getColumnPrefixFromDragDrop(draggableId);

                                swapColumnContents(dragColumnPrefix, dropColumnPrefix);
                            }

                            var draggableOnDrag = function(e) {
                                var draggableId = getDraggableIdFromEvent(e);

                                var isDroppable = e.dropTarget;

                                if (isDroppable && draggableId !== e.dropTarget.id) {
                                    setCursorAsDroppable();
                                } else {
                                    setCursorAsDenied();
                                }
                            };

                            var draggableOnDragStart = function (e) {
                                var draggableId = getDraggableIdFromEvent(e);
                                if (!draggableId) {
                                    draggableId = e.currentTarget[0].id;
                                }
                                if(draggableId) {
                                    $("#" + draggableId).addClass("draggableOnDrag");

                                    setCursorAsDragging();
                                }
                            }

                            var draggableOnDragEnd = function (e) {
                                //not implementing main drop operation here, since e does not contain the drag'n'drop elements!
                                var draggableId = getDraggableIdFromEvent(e);
                                var dropTargetId = getDropTargetIdFromEvent(e);

                                if (!draggableId) {
                                    draggableId = e.currentTarget[0].id;
                                }

                                restoreMouseAndUi(draggableId, dropTargetId);
                            }

                            var dragDropId = columnPrefix + '-pane-heading';

                            $("#" + dragDropId).kendoDraggable({
                                hint: function () {
                                    return $("#" + dragDropId).clone(); //TODO review will this work OK with real plots
                                },
                                drag: draggableOnDrag,
                                dragstart: draggableOnDragStart,
                                dragend: draggableOnDragEnd,
                                cursorOffset: { top: 10, left: 10 }
                            });

                            $("#" + dragDropId).kendoDropTarget({
                                dragenter: droptargetOnDragEnter,
                                dragleave: droptargetOnDragLeave,
                                drop: droptargetOnDrop
                            });
                        };

                        var swapColumnContents = function (sourceColumnPrefix, targetColumnPrefix) {
                            if (sourceColumnPrefix === targetColumnPrefix) {
                                return;
                            }

                            for (var rowSuffix in rowSuffixesIncludingMain) {
                                if (rowSuffixesIncludingMain.hasOwnProperty(rowSuffix)) {
                                    rowSuffix = rowSuffixesIncludingMain[rowSuffix];
                                    var sourcePaneId = sourceColumnPrefix + rowSuffix;
                                    var targetPaneId = targetColumnPrefix + rowSuffix;

                                    var sourceDiv = $('#' + sourcePaneId);
                                    var destDiv = $('#' + targetPaneId);

                                    swapChildrenOfDivs(sourceDiv, destDiv);
                                }
                            }
                        };

                        var swapChildrenOfDivs = function(sourceDiv, destDiv) {
                            //using detach() NOT remove() to preserve jQuery objects and events
                            var sourceChildren = sourceDiv.children().detach();
                            var destChildren = destDiv.children().detach();

                            sourceChildren.appendTo(destDiv);
                            destChildren.appendTo(sourceDiv);
                        };

                        var columnPrefixes = [
                            'column0', 'column1', 'column2', 'column3'
                        ];

                        var rowSuffixes = [
                            '-pane-heading', '-pane-footer'
                        ];

                        var rowSuffixesIncludingMain = [
                            '-pane-heading', '-pane-footer', '-pane-main'
                        ];

                        //adjust the pane sizes, after some resize event.
                        //unfortunately, kendo ui does not always provide the pane object that was resized.
                        //so, this function adjusts ALL panes, taking Main as the authority.
                        var adjustPaneSizes = function () {
                            var authorityPaneSuffix = '-pane-main';
                            
                            var rowSuffixToSplitter = [];

                            //using Null Object to handle edge cases during control creation (where 1 or more row splitters not yet created)
                            var nullObjectSplitter = {
                                size: function () {
                                }
                            };

                            rowSuffixToSplitter[rowSuffixes[0]] = headingsHorizontalSplitter ? headingsHorizontalSplitter : nullObjectSplitter;
                            rowSuffixToSplitter[rowSuffixes[1]] = footersHorizontalSplitter ? footersHorizontalSplitter : nullObjectSplitter;

                            var resizeOtherPanesInColumn = function (columnPrefix) {
                                var authorityPaneId = columnPrefix + authorityPaneSuffix;
                                var authorityPane = getPane(authorityPaneId);
                                var size = authorityPane.size;
                                if (authorityPane.collapsed) {
                                    size = 0;
                                }
                                if (typeof (size) === 'undefined') {
                                    //bug in kendo ui?
                                    size = $('#' + authorityPaneId).width();
                                }

                                for (var rowSuffix in rowSuffixes) {
                                    if (rowSuffixes.hasOwnProperty(rowSuffix)) {
                                        rowSuffix = rowSuffixes[rowSuffix];
                                        var targetPaneId = columnPrefix + rowSuffix;

                                        var splitter = rowSuffixToSplitter[rowSuffix];
                                        splitter.size('#' + targetPaneId, size);
                                    }
                                }
                            };

                            for (var columnPrefix in columnPrefixes) {
                                if (columnPrefixes.hasOwnProperty(columnPrefix)) {
                                    columnPrefix = columnPrefixes[columnPrefix];
                                    resizeOtherPanesInColumn(columnPrefix);
                                }
                            }
                        };

                        var getPane = function (id) {
                            return $('#' + id).data('pane');
                        };

                        function onResizeMainHorizontal() {
                            console.log("Resized :: Splitter <b>#" + this.element[0].id + "</b>");
                            adjustPaneSizes();
                        }

                        function onExpandMainHorizontal(e) {
                            console.log("Expanded :: Pane <b>#" + e.pane.id + "</b> from splitter <b>#" + this.element[0].id + "</b> expanded");
                        }

                        function onCollapseMainHorizontal(e) {
                            console.log("Collapsed :: Pane <b>#" + e.pane.id + "</b> from splitter <b>#" + this.element[0].id + "</b> collapsed");
                        }

                        function onContentLoadMainHorizontal(e) {
                            console.log("Content loaded in <b>#" + e.pane.id +
                                "</b> and starts with <b>" + $(e.pane).text().substr(0, 20) + "...</b>");
                        }
                    </script>

                    <style>
                        #vertical {
                            margin: 0 auto;
                        }

                        .pane-content {
                            padding: 0 10px;
                        }

                        .stretch-image {
                            margin: 0;
                            height: 99%;
                            width: 100%;
                        }

                        .dropTargetEntered {
                            border: cyan solid 2px;
                            -ms-border-radius: 10px;
                            border-radius: 10px;
                        }

                        .draggableOnDrag {
                            border: yellow solid 2px;
                            -ms-border-radius: 10px;
                            border-radius: 10px;
                            background-color: #03a9f4;
                            -webkit-box-shadow: 0 3px 10px #000000, 0 3px 10px #000000;
                            -ms-box-shadow: 0 3px 10px #000000, 0 3px 10px #000000;
                            box-shadow: 0 3px 10px #000000, 0 3px 10px #000000;
                        }
                    </style>
                </div>
            </td>
        </tr>
    </table>

</body>
</html>
